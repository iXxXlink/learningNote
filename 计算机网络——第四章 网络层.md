## 计算机网络——第四章 网络层

1. 主机和路由器都有网络层

2. 路由选择算法：分组从发送方流向接受方时，网络层决定这些分组所采取的路径的算法

3. 分组交换机分为：路由器（网络层）和链路层交换机（链路层）

   1. | 应用层     | 报文message       |
      | ---------- | ----------------- |
      | 传输层     | 报文段segment     |
      | 网络层     | 数据报datagram    |
      | 数据链路层 | 帧frame           |
      | 物理层     | 数据单元data unit |

4. 转发表：每个路由器所拥有的，通过检查数据报的头部字段，再依照转发表，决定数据包转发至哪条链路（路由算法即决定每一个网络中路由器的转发表）

5. 网络层模型：带宽、丢包、按序、及时、拥塞反馈

   1. <img src="C:\Users\Lch\AppData\Roaming\Typora\typora-user-images\image-20200615020500002.png" alt="image-20200615020500002" style="zoom: 33%;" />

6. 包交换网络包括：虚电路网络（例如上图中的ATM，有连接）和数据报网络（internet网络，无连接）

7. 一条虚电路（VC）包括：路径（链路+路由器），VC numbers（每一条链路上的编号），记录entries（路由器上的转发表）。所以每个packet使用VC编号而不用IP，VC编号在每条链路上时会改变（新VC编号从转发表中获得）

8. 虚电路网络建立一条虚电路的过程：

   1. 网络层决定一条由发送方到达接受方的path
   2. 网络层决定每一条path中每一条链路的VC number
   3. 网络层使path中的每一台路由器更 新转发表

9. 数据报交换网络：包可能通过不同路径到达目的地，因为路由选择算法可能通过每条路的实时拥塞程度而选择实时路由

10. internet中路由器也有转发表，根据目的ip的范围决定输出链路

11. 最长前缀匹配：将ip转为二进制形式，选择能与目的ip最长前缀匹配的链路输出

12. IPv4 format（）

    1. <img src="C:\Users\Lch\AppData\Roaming\Typora\typora-user-images\image-20200615025147591.png" alt="image-20200615025147591" style="zoom:50%;" />
    2. 在网络层此处包含源和目的ip地址（传输层就不需要写了）
    3. 头部典型长度20B与TCP的典型字节一样，UDP是固定8字节，ipv6是固定40字节,由此的head len和length可以知道TCP/UDP报文的总长度
    4. 没经过一次路由器就要从新计算一次check sum（因为每过一个路由器TTL就会改变）
    5. 网络层的checksum只对头部字段，而传输层的checksum对于整个segment

13. MTU（最大传输单元）：即网络层能承载到的最大数据包大小（头部+data）

14. 默认网关：终端所连接的第一台路由器

15. ip地址可以认为是路由接口，路由器的每一个接口都对应一个ip（主机一般1个ip；路由器可以有多个ip，不同ip对应不同的网络）

16. 子网：设备可以物理上抵达其他设备所构成的网络（路径中没有路由器）（路由器不同的接口分割了不同的子网）（即使2台路由器接口间无终端设备，也称之为一个子网）

17. 子网的网络地址+子网掩码即可用于标识子网，例如223.1.1.0/24，其中223.1.1.0是子网网络地址（即子网中第一个ip地址），/24是子网掩码（11111111 11111111 11111111 00000000）（即指的是从左往右数1的个数）

18. 子网网络地址可以通过子网中任意一个IP地址与子网掩码取与运算获得，除网络部分的称为主机地址

19. 主机地址全0是网络地址，全1是广播地址，所以可用主机数量最多为$n=2^x-2$，（此处为可用ip地址，==包括路由器接口的ip==）

20. 私有IP地址分类(一组专门用于私有网络的ip，不被internet分配，也不会在Internet上路由，但可以通过NAT技术与Internet通信)

    1. A类10.0.0.0-10.255.255.255（即10.0.0.0/8）
    2. B类172.16.0.0-172.31.255.255（即172.16.0.0/12）
    3. C类192.168.0.0-192.168.255.255（即192.168.0.0/16)

21. 路由聚合：使用单个网络前缀代表多个子网的能力称为地址聚合或路由聚合

22. ICANN：分配ip、分配域名、管理DNS根服务器

23. 如何获得IP地址：

    1. 硬编码：手动设置ip，但是需要熟悉自身网关信息、子网信息后依此获得
    2. DHCP(动态主机配置协议)（==使用udp的应用层协议==）：动态地从DHCP服务器（一般是路由器）中获得ip。还可以从DHCP中获得子网掩码、默认网关、本地DNS服务器
       1. DHCP流程：
       2. DHCP discover：申请者发送一个目的ip为255.255.255.255（广播地址），端口为67，源ip为0.0.0.0，源端口是68的信息，还包括yiaddr0.0.0.0(建议ip)，和transactionID
       3. DHCP offer：DHCP服务器发送一个目的ip是255.255.255.255(广播地址)，目标端口68，源ip，源端口68，data中包括transactionID、yiaddr、子网掩码、租赁时间
       4. DHCP request：申请者选择一个ipoffer然后返送DHCPrequest的消息，目的ip255.255.255.255，目的端口67，源ip0.0.0.0，源端口68，还有yiaddr、transactionID（新id）
       5. DHCP服务器收到后发送DHCP ack，目的ip255.255.255.255，目的端口68.
       6. 因为直到申请者收到最后的DHCP服务器的ack，才真正获得ip，所以之前申请者发送的源ip都是0.0.0.0，目的ip都是255.255.255.255，DHCP服务发送的都是目的ip255.255.255.255.（==即二者都是通过广播对话，通过transactionID标识对方==）

24. NAT(网络地址转换)：为解决ip地址不足，默认网关（拥有公网ip）分配给子网中主机私有ip。使得只需一个公网IP就能够使整个子网都能与Ineternet通信

    1. 子网中不同私有ip的数据报进入Internet时拥有相同的源IP和不同的端口
    2. 私有IP只能用于子网中通信
    3. NAT路由器需要做的事
       1. 将内网中向外运输的数据报中源IP、源端口替换为路由器IP、一个新的端口号
       2. 创建一个NAT转换表：源ip和源端口对应 一个新的端口
       3. 收到外网向内网传递的信息时，将目的ip、目的端口根据（2）中NAT转换表转为子网ip和子网端口

25. NAT穿越

    1. 在路由器上静态设置公网IP和端口对应的内网IP和端口
    2. UPnP：增加端口映射
    3. 中继服务器：让客户端和服务端都访问一个中继服务器

26. ICMP（控制报文协议）（网络层协议？）：在IP的datagrams中，类似于TCP、UDP，用于在主机和路由器间交流网络层信息（ping、错误信息、请求回复 ）

27. Traceroute工作原理：主机发送n个UDP报文，第x个的报文TTL=X，第x报文到达地X路由器后返回一个ICMP信息包括该路由器名字和ip（对于同一个TTL值发送3个包）

28. IPv6，（128位，ipv4是32位）

    1. 不再进行分配，no fragmentation allowed
    2. 去掉了checksum字段，options字段不在首部中出现，在Next header字段中
    3. 头部字段固定==40==个字节
    4. <img src="计算机网络——第四章 网络层.assets/image-20200619074406936.png" alt="image-20200619074406936" style="zoom:50%;" />

29. IPV4到IPV6的过度

    1. 双栈模式：服务器同时支持ipv4和ipv6，如果途中某个路由器只支持ipv4，必须将ipv6转为ipv4（如果之后再转成ipv6可能会带来信息损失）
    2. 隧道模式：如果经过只支持ipv4的路由器，则将ipv6的报文整个放入新ipv4报文的payload中，之后遇到支持ipv6的路由器后，取出payload作为报文传输

30. 路由算法（重点）

    1. 全局式路由算法（例如，LS链路状态算法）：网络中每个路由器都知道网络的拓扑结构和每条链路的状况

       | C(x,y) | x到y的代价                       |
       | ------ | -------------------------------- |
       | D(v)   | 原点到v的最小代价路径的值        |
       | p(v)   | 到v的最小代价路径中，v的前继节点 |
       | N‘     | 已确定最小代价路径中的节点集合   |

       1. 初始化时将原点u放入N'中，然后把u作为最小代价路径中的前置节点，计算达到其他所有节点的代价值（不可达记为$\infty$）
       2. 然后将计算拥有最小代价值路径的终点x放入N'中，然后将x作为前置节点，路径前一部分是u到x的路径，然后计算达到其他所有节点（不包括N’）的代价，不可达记作$\infty$
       3. 循环2过程。
       4. 以上为迪杰斯特拉算法，算法的内涵是一点到其所有相邻点中的路径的最小值，就是该点到路径终点的最小代价路径，因为如果还有其他最小路径，则必须经过其他相邻点，而该点到其他相邻点的距离又大于最小值，所以产生矛盾。而每次迭代，使用已确定最小值的N‘集合作为中间点更新所能达到点的最小代价值，再在其中取最小值作为又一点的最小代价路径，因为如果有更小代价路径到达该点，则也要使用其他路径作为部分路径，而该路径已经是现存最小路径，其他从原点出发的路径均大于路径，所以每次去最小路径都必是最小代价路径。(==如果源节点到达目标节点的路径是最小代价路径，那么源节点达到该终点的前置节点（其实路径上的每个节点都是！）的路径也是最小代价路径==)（所以可以通过迭代的方式由近及远获得所有最小代价路径）

31. 根据迪杰斯特拉算法得到的路径，可以获得某一源点到其他节点的最小路径树。然后根据最小路径树，每个节点可以得到一个转发表：记载要通过最小路径时需要前往的相邻一条链路(就是该节点与相邻节点形成的链路)与对应目的节点

32. 链路状态算法的缺点：振荡效应，因为每个路由器都知道整个网络的情况所以，会产生一旦某条链路的流量小，其他路由器都会转向该链路，造成链路流量变大，失去优越性，之后又转为其他流量小的链路。产生的原因是路由器几乎同步获取信息并改变策略。所以解决的方法是路由器异步发送自身状态的信息。

33. 分散式算法（例如，DV距离向量算法那）：每个路由器只知道自身以及相邻路由器有关链路的情况

34. 贝尔曼福特方程：$d_{x}(y)$表示X到y的最小代价路径值，所以有$d_{x}(y)=min\{c(x,v),d_v(y)\}$,其中v表示x的所有邻居节点。（其本质和迪杰斯特拉算法一样，迪杰斯特拉算法是通过逐步获得最小路径进而在获得的最小路径基础上获得新的最小路径，而BF则是逐步将$d_x(y)$作为未知量迭代，最终当x和y相邻时，$d_x(y)=c(x,y)$,为已知量，在将此已知量回带回之前迭代的方程中，算出一系列最小路径值）

35. DV(距离向量算法)：$D_x(y)$表示x到y最小路径的估计值。每一个节点内部保存了到达向量节点的真实值C（y），和到达其他节点的估计值D（y），并且节点可以将自己存储的D（y）传递给相邻节点

    1. 当节点自身的C（y），发生改变时，会根据邻居发的DV信息和新的C（y）信息，使用BF方程更新自己的DV信息，并将新的DV信息发送给邻居。（DV信息即该节点到其他节点最短路径的估计值）
    2. 当节点收到邻居法的DV时，根据自己的C（y）和新的邻居DV信息，使用BF方程更新自己的DV信息（如果未改变则不发送），然后再发给所有邻居
    3. 通过不断迭代，最终每个节点中的DV信息接近真实的最短路径

36. 毒性逆转？

37. 自治系统AS：一个范围内的路由器形成区域，自己管理区域，不需要与区域外的路由器交换状态信息

38. 网关路由器：位于AS边缘，用于AS之间的连接的路由器 

    <img src="计算机网络——第四章 网络层.assets/image-20200619064316269.png" alt="image-20200619064316269" style="zoom:50%;" />

39. 当AS有多个网关路由器时，需要决定通过哪个网关路由器出去时，要使用域间路由协议（inter-AS routing protocol，常用BGP4）：会使子网中的路由器知道，每个网关路由器出去后，能到达哪些地方。

40. 热土豆路由：当多个网关出口都能达到目的地时，选择路径代价最小的网关作为出口。（只关心子网内部情况，子网内部最快即可，外部的流量情况交给外部的AS去管！）

41. inter域间：BGP

42. intra域内（应用层协议）:RIP（DV）、OSPF（LS）、IGRP（DV）